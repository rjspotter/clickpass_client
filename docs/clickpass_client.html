<!DOCTYPE html>  <html> <head>   <title>clickpass_client.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               clickpass_client.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-1">#</a>               </div>               <p>This client works with the next version of Clickpass
api simplicity is the goal:
 * a single include
 * a single function call with...
 * a single identifier
 * a single object for passing callbacks and configuration</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-2">#</a>               </div>               <p>The API is modeled on jQuery's $.ajax() call with some of the old FB api for spice.
this is an experimental release.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nb">window</span><span class="p">.</span><span class="nv">ClickpassClient = </span><span class="nf">() -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-3">#</a>               </div>               <p>parse out the arguments.  having an explicit function signature ala
ClickpassClient(rpid,config) would lock us in.  Taking arbitrary args and parsing
them out is a lot more flexible</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">rpid   = </span><span class="nx">arguments</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
  <span class="nv">config = </span><span class="nx">arguments</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-4">#</a>               </div>               <p>Later on were going to want to be able to branch code or reject input based on
it's type or value.  So we need to know if it's a function before calling it.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">isFun = </span><span class="nf">(a) -&gt;</span>
    <span class="k">return</span> <span class="k">typeof</span> <span class="nx">a</span> <span class="o">==</span> <span class="s1">&#39;function&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-5">#</a>               </div>               <p>Or, we need to know what the value of the hash is in the url
So far we only need to know if the hash has a particular value
thus hashIs takes an argument to compare against</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">hashIs = </span><span class="nf">(check) -&gt;</span>
    <span class="k">return</span> <span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">hash</span> <span class="o">==</span> <span class="nx">check</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-6">#</a>               </div>               <p>Since we expect there to be multiple versions of Clickpass existing in parallel
at very least we expect a bleeding edge (next), a stable (current), and development (dev)
version to be running we use a short reference url mapper (opUrl => OpenID Provider URL).</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">opUrl = </span><span class="nf">() -&gt;</span>
    <span class="k">return</span> <span class="k">switch</span> <span class="nx">config</span><span class="p">.</span><span class="nx">cpEnvType</span>
      <span class="k">when</span> <span class="s1">&#39;next&#39;</span>    <span class="k">then</span> <span class="s1">&#39;http://next.clickpass.com/server?m=s&amp;cp.rpid=&#39;</span> <span class="o">+</span> <span class="nx">rpid</span>
      <span class="k">when</span> <span class="s1">&#39;current&#39;</span> <span class="k">then</span> <span class="s1">&#39;http://next.clickpass.com/server?m=s&amp;cp.rpid=&#39;</span> <span class="o">+</span> <span class="nx">rpid</span>
      <span class="k">when</span> <span class="s1">&#39;dev&#39;</span>     <span class="k">then</span> <span class="s1">&#39;http://dev.clickpass.com/server?m=s&amp;cp.rpid=&#39;</span> <span class="o">+</span> <span class="nx">rpid</span>
      <span class="k">else</span> <span class="s1">&#39;http://next.clickpass.com/server?m=s&amp;cp.rpid=&#39;</span> <span class="o">+</span> <span class="nx">rpid</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-7">#</a>               </div>               <p>Part of the beauty of Clickpass compared to other third party providers is that
user data (sreg attributes) is provided at login time updated during each login
no extra api call required.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">sregAttributes = </span><span class="nf">() -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-8">#</a>               </div>               <p>We need a few helper functions that are only used while parsing out the sreg
data.  We keep those inside the function definition for cleanliness.
We like a functional lean so to start with a cdr implementation based on js
arrays.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">cdr = </span><span class="nf">(arr) -&gt;</span>
      <span class="k">return</span> <span class="nx">arr</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nx">arr</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-9">#</a>               </div>               <p>fromGlobal returns an sreg attribute from the Clickpass Data stored in an out of the
way attribute on the window object.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">fG = </span><span class="nf">(k) -&gt;</span>
      <span class="k">return</span> <span class="nb">window</span><span class="p">.</span><span class="nx">__cp_data</span><span class="p">[</span><span class="s1">&#39;openid.sreg.&#39;</span> <span class="o">+</span> <span class="nx">k</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-10">#</a>               </div>               <p>appenD allows us to build a handy object impersonating a hash.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">aD = </span><span class="nf">(col,k,v) -&gt;</span>
      <span class="nx">col</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span> <span class="o">=</span> <span class="nx">v</span>
      <span class="k">return</span> <span class="nx">col</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-11">#</a>               </div>               <p>Putting it all together; Since we don't know what sreg attributes are expected on
this side we recurse down the whole list and build an object with only the ones
that were returned.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">extract = </span><span class="nf">(lst, col) -&gt;</span>
       <span class="k">return</span> <span class="k">if</span> <span class="nx">lst</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="kc">undefined</span> <span class="k">then</span> <span class="nx">col</span> <span class="k">else</span>
              <span class="k">if</span> <span class="nx">fG</span><span class="p">(</span><span class="nx">lst</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="kc">undefined</span>
                <span class="nx">extract</span><span class="p">(</span><span class="nx">cdr</span><span class="p">(</span><span class="nx">lst</span><span class="p">),</span> <span class="nx">col</span><span class="p">)</span>
              <span class="k">else</span>
                <span class="nx">extract</span><span class="p">(</span><span class="nx">cdr</span><span class="p">(</span><span class="nx">lst</span><span class="p">),</span> <span class="nx">aD</span><span class="p">(</span><span class="nx">col</span><span class="p">,</span><span class="nx">lst</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="nx">unescape</span><span class="p">(</span><span class="nx">fG</span><span class="p">(</span><span class="nx">lst</span><span class="p">[</span><span class="mi">0</span><span class="p">]))))</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-12">#</a>               </div>               <p>Finally we return the result.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">return</span> <span class="nx">extract</span><span class="p">([</span>
      <span class="s1">&#39;nickname&#39;</span><span class="p">,</span>
      <span class="s1">&#39;fullname&#39;</span><span class="p">,</span>
      <span class="s1">&#39;email&#39;</span><span class="p">,</span>
      <span class="s1">&#39;dob&#39;</span><span class="p">,</span>
      <span class="s1">&#39;gender&#39;</span><span class="p">,</span>
      <span class="s1">&#39;timezone&#39;</span><span class="p">,</span>
      <span class="s1">&#39;language&#39;</span><span class="p">,</span>
      <span class="s1">&#39;country&#39;</span><span class="p">,</span>
      <span class="s1">&#39;postcode&#39;</span><span class="p">],</span>
      <span class="p">{}</span>
    <span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-13">#</a>               </div>               <p>On to the subject of user experience.
Get the element that clicking on will start the process of logging in.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">ele = </span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">uiElement</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-14">#</a>               </div>               <p>Then when it's clicked....</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">ele.onclick = </span><span class="nf">() -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-15">#</a>               </div>               <p>Grab the current hash so we can return it to it's state when we're done.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">oldHash = </span><span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">hash</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-16">#</a>               </div>               <p>Open up a popup window for us to use conforming to the <a href="http://svn.openid.net/repos/specifications/user_interface/1.0/trunk/openid-user-interface-extension-1_0.html#anchor4">OpenID User Interface Extension 1.0 - DRAFT 0.5</a> and give it focus.  Stuff and <em>hand-wavey-jesture</em> things happen at Clickpass.com</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">authPop = </span><span class="nb">window</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="nx">opUrl</span><span class="p">(),</span> <span class="s1">&#39;authPop&#39;</span><span class="p">,</span> <span class="s1">&#39;width=&quot;450&quot;,height=&quot;500&quot;,location=&quot;true&quot;&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">focus</span><span class="p">)</span> <span class="k">then</span> <span class="nx">authPop</span><span class="p">.</span><span class="nx">focus</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-17">#</a>               </div>               <p>When we get focus back from Clickpass.com we call the success callback with the sreg data from above
or we call the failure callback.  Finally we cleanup and wash our hands.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nb">window</span><span class="p">.</span><span class="nv">onfocus = </span><span class="nf">() -&gt;</span>
      <span class="k">if</span> <span class="p">(</span> <span class="nx">hashIs</span><span class="p">(</span><span class="s1">&#39;#finished&#39;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">isFun</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">onSuccess</span><span class="p">))</span>
        <span class="nx">config</span><span class="p">.</span><span class="nx">onSuccess</span><span class="p">(</span><span class="nx">sregAttributes</span><span class="p">())</span>
      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">isFun</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">onFailure</span><span class="p">)</span> <span class="p">)</span>
        <span class="nx">config</span><span class="p">.</span><span class="nx">onFailure</span><span class="p">()</span>
      <span class="nb">window</span><span class="p">.</span><span class="nv">location.hash = </span><span class="nx">oldHash</span>
      <span class="nb">window</span><span class="p">.</span><span class="nv">onfocus = </span><span class="kc">null</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 